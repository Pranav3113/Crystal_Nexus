{% extends "base.html" %}
{% block title %}Approval Rules{% endblock %}
{% block header %}Approval Rules{% endblock %}

{% block content %}

<style>
  .card-soft { border: 1px solid rgba(0,0,0,.06); border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
  .badge-soft { padding: .45rem .75rem; border-radius: 999px; font-weight: 600; font-size: .75rem; }
  .badge-active { background: rgba(25,135,84,.14); color:#146c43; }
  .badge-inactive { background: rgba(220,53,69,.10); color:#b02a37; }
  .badge-steps { background: rgba(13,110,253,.12); color:#0b5ed7; }
  .muted { color:#64748b; }
  .form-hint { font-size: .75rem; color:#64748b; }
  .table thead th { font-size: .85rem; color:#64748b; }
  .mono { font-variant-numeric: tabular-nums; }
</style>

<div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-3">
  <div>
    <h4 class="mb-0">Approval Rule Master</h4>
    <div class="text-muted">
      Configure quote approval thresholds & sequential approvers (Role or User).
    </div>
  </div>
</div>

<div class="row g-3">

  <!-- Create Rule -->
  <div class="col-12 col-lg-4">
    <div class="card card-soft shadow-soft">
      <div class="card-body">
        <div class="fw-semibold mb-2">Create Rule</div>

        <form method="post" class="vstack gap-2">
          <input type="hidden" name="action" value="rule_create">

          <div>
            <label class="form-label">Rule Name</label>
            <input class="form-control" name="name" required placeholder="e.g., Manager + Director Approval">
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Min Amount</label>
              <input class="form-control mono" name="min_amount" placeholder="0">
            </div>
            <div class="col-6">
              <label class="form-label">Max Amount</label>
              <input class="form-control mono" name="max_amount" placeholder="(blank = no max)">
            </div>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">Order</label>
              <input class="form-control" name="sort_order" value="1">
            </div>
            <div class="col-6">
              <label class="form-label">Active</label>
              <select class="form-select" name="is_active">
                <option value="1" selected>Yes</option>
                <option value="0">No</option>
              </select>
            </div>
          </div>

          <div class="d-flex justify-content-end pt-1">
            <button class="btn btn-primary">
              <i class="bi bi-plus-lg me-1"></i>Create
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="alert alert-info mt-3 mb-0">
      <div class="fw-semibold mb-1">How approvals work</div>
      <ul class="mb-0 small">
        <li>Rules are matched by quote total amount.</li>
        <li>Steps run sequentially (Step Order).</li>
        <li>Each step can be assigned to a Role <b>or</b> a User.</li>
      </ul>
    </div>
  </div>

  <!-- Rules list -->
  <div class="col-12 col-lg-8">
    <div class="card card-soft shadow-soft">
      <div class="card-body">
        <div class="fw-semibold mb-2">Rules</div>

        {% if rules|length == 0 %}
          <div class="text-muted">No rules yet. Create your first rule.</div>
        {% else %}

          <div class="accordion" id="rulesAcc">

            {% for r in rules %}
            {% set active_steps_count = r.steps.filter_by(is_active=True).count() %}
            <div class="accordion-item rounded-4 overflow-hidden mb-2">

              <h2 class="accordion-header" id="h{{ r.id }}">
                <button class="accordion-button {% if not loop.first %}collapsed{% endif %}" type="button"
                        data-bs-toggle="collapse" data-bs-target="#c{{ r.id }}">
                  <div class="w-100 d-flex justify-content-between align-items-center gap-2">
                    <div>
                      <div class="fw-semibold">{{ r.name }}</div>
                      <div class="muted small">
                        <span class="mono">Min: {{ r.min_amount or 0 }}</span>
                        •
                        <span class="mono">Max: {{ r.max_amount if r.max_amount is not none else '∞' }}</span>
                        • Order: {{ r.sort_order }}
                        •
                        {% if r.is_active %}
                          <span class="badge-soft badge-active">Active</span>
                        {% else %}
                          <span class="badge-soft badge-inactive">Inactive</span>
                        {% endif %}
                      </div>
                    </div>

                    <span class="badge-soft badge-steps">
                      Steps: {{ active_steps_count }}
                    </span>
                  </div>
                </button>
              </h2>

              <div id="c{{ r.id }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}"
                   data-bs-parent="#rulesAcc">
                <div class="accordion-body">

                  <!-- Update Rule -->
                  <form method="post" class="row g-2 align-items-end mb-3">
                    <input type="hidden" name="action" value="rule_update">
                    <input type="hidden" name="rule_id" value="{{ r.id }}">

                    <div class="col-12">
                      <label class="form-label">Rule Name</label>
                      <input class="form-control" name="name" value="{{ r.name }}" required>
                    </div>

                    <div class="col-6">
                      <label class="form-label">Min Amount</label>
                      <input class="form-control mono" name="min_amount" value="{{ r.min_amount or 0 }}">
                    </div>

                    <div class="col-6">
                      <label class="form-label">Max Amount</label>
                      <input class="form-control mono" name="max_amount"
                             value="{{ r.max_amount if r.max_amount is not none else '' }}">
                    </div>

                    <div class="col-6">
                      <label class="form-label">Order</label>
                      <input class="form-control" name="sort_order" value="{{ r.sort_order }}">
                    </div>

                    <div class="col-6">
                      <label class="form-label">Active</label>
                      <select class="form-select" name="is_active">
                        <option value="1" {% if r.is_active %}selected{% endif %}>Yes</option>
                        <option value="0" {% if not r.is_active %}selected{% endif %}>No</option>
                      </select>
                    </div>

                    <div class="col-12 d-flex justify-content-end">
                      <button class="btn btn-outline-dark btn-sm">
                        <i class="bi bi-save2 me-1"></i>Update Rule
                      </button>
                    </div>
                  </form>

                  <hr class="my-3">

                  <!-- Steps -->
                  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                    <div class="fw-semibold">Steps (Sequential)</div>
                    <div class="form-hint">
                      Tip: choose <b>Role OR User</b> per step.
                    </div>
                  </div>

                  {% set steps = r.steps|sort(attribute='step_order') %}

                  <div class="table-responsive">
                    <table class="table align-middle">
                      <thead class="table-light">
                        <tr>
                          <th style="width:90px;">Step</th>
                          <th style="width:220px;">Approver Role</th>
                          <th>Approver User</th>
                          <th style="width:120px;">Active</th>
                          <th class="text-end" style="width:160px;">Actions</th>
                        </tr>
                      </thead>
                      <tbody>

                        {% for s in steps %}
                        <tr>
                          <form method="post" class="step-row-form">
                            <input type="hidden" name="action" value="step_update">
                            <input type="hidden" name="step_id" value="{{ s.id }}">

                            <td>
                              <input class="form-control form-control-sm mono"
                                     name="step_order"
                                     value="{{ s.step_order }}"
                                     style="max-width:90px;">
                            </td>

                            <td>
                              <select class="form-select form-select-sm step-role" name="approver_role" data-step="{{ s.id }}">
                                <option value="">— None —</option>
                                {% for rr in roles %}
                                  <option value="{{ rr.name }}" {% if s.approver_role==rr.name %}selected{% endif %}>
                                    {{ rr.name }}
                                  </option>
                                {% endfor %}
                              </select>
                            </td>

                            <td>
                              <select class="form-select form-select-sm step-user" name="approver_user_id" data-step="{{ s.id }}">
                                <option value="">— None —</option>
                                {% for u in users %}
                                  <option value="{{ u.id }}" {% if s.approver_user_id==u.id %}selected{% endif %}>
                                    {{ u.name }} ({{ u.email }})
                                  </option>
                                {% endfor %}
                              </select>
                            </td>

                            <td>
                              <select class="form-select form-select-sm" name="is_active">
                                <option value="1" {% if s.is_active %}selected{% endif %}>Yes</option>
                                <option value="0" {% if not s.is_active %}selected{% endif %}>No</option>
                              </select>
                            </td>

                            <td class="text-end">
                              <div class="d-inline-flex gap-2">
                                <button class="btn btn-sm btn-outline-dark">
                                  <i class="bi bi-save2"></i>
                                </button>
                          </form>

                              <form method="post" class="m-0">
                                <input type="hidden" name="action" value="step_delete">
                                <input type="hidden" name="step_id" value="{{ s.id }}">
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="return confirm('Delete this step?');">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </form>
                              </div>
                            </td>
                        </tr>
                        {% endfor %}

                        {% if steps|length == 0 %}
                        <tr>
                          <td colspan="5" class="text-center text-muted py-3">
                            No steps added yet.
                          </td>
                        </tr>
                        {% endif %}

                      </tbody>
                    </table>
                  </div>

                  <!-- Add Step -->
                  <div class="mt-3 p-3 rounded-4 border bg-light">
                    <div class="fw-semibold mb-2">Add Step</div>

                    <form method="post" class="row g-2 align-items-end step-add-form">
                      <input type="hidden" name="action" value="step_add">
                      <input type="hidden" name="rule_id" value="{{ r.id }}">

                      <div class="col-12 col-md-2">
                        <label class="form-label">Step Order</label>
                        <input class="form-control mono" name="step_order" value="{{ (steps|length + 1) }}">
                      </div>

                      <div class="col-12 col-md-4">
                        <label class="form-label">Approver Role</label>
                        <select class="form-select step-add-role" name="approver_role">
                          <option value="">— None —</option>
                          {% for rr in roles %}
                            <option value="{{ rr.name }}">{{ rr.name }}</option>
                          {% endfor %}
                        </select>
                        <div class="form-hint mt-1">Choose Role OR User</div>
                      </div>

                      <div class="col-12 col-md-6">
                        <label class="form-label">Approver User</label>
                        <select class="form-select step-add-user" name="approver_user_id">
                          <option value="">— None —</option>
                          {% for u in users %}
                            <option value="{{ u.id }}">{{ u.name }} ({{ u.email }})</option>
                          {% endfor %}
                        </select>
                      </div>

                      <div class="col-12 d-flex justify-content-end">
                        <button class="btn btn-outline-primary">
                          <i class="bi bi-plus-lg me-1"></i>Add Step
                        </button>
                      </div>
                    </form>
                  </div>

                </div>
              </div>

            </div>
            {% endfor %}

          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<script>
  // Enforce "Role OR User" selection per step row
  function toggleRoleUser(stepId) {
    const roleSel = document.querySelector(`.step-role[data-step="${stepId}"]`);
    const userSel = document.querySelector(`.step-user[data-step="${stepId}"]`);
    if (!roleSel || !userSel) return;

    const hasRole = (roleSel.value || "").trim() !== "";
    const hasUser = (userSel.value || "").trim() !== "";

    // If role chosen -> disable user; if user chosen -> disable role; else enable both
    if (hasRole && !hasUser) {
      userSel.disabled = true;
      roleSel.disabled = false;
    } else if (!hasRole && hasUser) {
      roleSel.disabled = true;
      userSel.disabled = false;
    } else {
      roleSel.disabled = false;
      userSel.disabled = false;
    }
  }

  // Apply for all existing rows
  document.querySelectorAll(".step-role").forEach(sel => {
    const stepId = sel.getAttribute("data-step");
    toggleRoleUser(stepId);
    sel.addEventListener("change", () => toggleRoleUser(stepId));
  });
  document.querySelectorAll(".step-user").forEach(sel => {
    const stepId = sel.getAttribute("data-step");
    toggleRoleUser(stepId);
    sel.addEventListener("change", () => toggleRoleUser(stepId));
  });

  // Add-step form: same rule
  const addRole = document.querySelector(".step-add-role");
  const addUser = document.querySelector(".step-add-user");

  function toggleAddForm() {
    if (!addRole || !addUser) return;
    const hasRole = (addRole.value || "").trim() !== "";
    const hasUser = (addUser.value || "").trim() !== "";
    if (hasRole && !hasUser) {
      addUser.disabled = true;
      addRole.disabled = false;
    } else if (!hasRole && hasUser) {
      addRole.disabled = true;
      addUser.disabled = false;
    } else {
      addRole.disabled = false;
      addUser.disabled = false;
    }
  }

  if (addRole && addUser) {
    toggleAddForm();
    addRole.addEventListener("change", toggleAddForm);
    addUser.addEventListener("change", toggleAddForm);
  }
</script>

{% endblock %}