{% extends "base.html" %}
{% block title %}Account Health{% endblock %}
{% block header %}Account Health (AM){% endblock %}

{% block content %}
<style>
  .kpi { font-size: 1.25rem; font-weight: 800; }
  .muted { color:#6c757d; }
  .badge-soft { padding:.4rem .6rem; border-radius:999px; font-weight:700; }
  .b-green { background: rgba(25,135,84,.15); color:#146c43; }
  .b-amber { background: rgba(245,124,0,.15); color:#c25f00; }
  .b-red { background: rgba(220,53,69,.15); color:#b02a37; }
  .card-soft { border: 1px solid rgba(0,0,0,.06); border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }

  .row-risk { background: rgba(245,124,0,.06); }
  .row-inactive { background: rgba(220,53,69,.06); }

  @media print{
    .no-print{ display:none !important; }
    .card, .card-soft { box-shadow:none !important; }
    body { background:#fff !important; }
  }
</style>

{% set cluster_label = (cluster.name if cluster else "All Clusters") %}

<div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
  <form method="get" class="d-flex gap-2 align-items-end no-print">
    <div>
      <label class="form-label mb-1">Month</label>
      <input type="month" class="form-control" name="month" value="{{ month_value }}">
    </div>

    <div>
      <label class="form-label mb-1">Cluster</label>
      <select class="form-select" name="cluster_id">
        <option value="">All Clusters</option>
        {% for c in clusters %}
          <option value="{{ c.id }}" {% if cluster_id == (c.id|string) %}selected{% endif %}>
            {{ c.name }} (Head: {{ c.head_user.name if c.head_user else '—' }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="pb-1 d-flex gap-2">
      <button class="btn btn-outline-dark">
        <i class="bi bi-funnel me-1"></i>Apply
      </button>

      <a class="btn btn-dark"
         href="{{ url_for('reports.cluster_account_health', month=month_value, cluster_id=cluster_id, format='pdf') }}">
        <i class="bi bi-file-earmark-pdf me-1"></i>Download PDF
      </a>
    </div>
  </form>

  <div class="text-muted small text-end">
    <div>Cluster: <span class="fw-semibold">{{ cluster_label }}</span></div>
    <div>Report date: <span class="fw-semibold">{{ ref_date }}</span></div>
    <div>
      Period: <span class="fw-semibold">{{ start_date }}</span> to <span class="fw-semibold">{{ end_date }}</span>
    </div>
    <div class="text-muted">
      Scope: <b>AM</b> users only (team_role = AM)
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-md-4">
    <div class="card card-soft">
      <div class="card-body">
        <div class="muted small">Active Clients</div>
        <div class="kpi">{{ active_clients or 0 }}</div>
        <div class="text-muted small mt-1">Last invoice within 60 days.</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card card-soft">
      <div class="card-body">
        <div class="muted small">Dormant Risk</div>
        <div class="kpi">{{ dormant_risk or 0 }}</div>
        <div class="text-muted small mt-1">Last invoice 61–90 days ago.</div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-4">
    <div class="card card-soft">
      <div class="card-body">
        <div class="muted small">Inactive Accounts</div>
        <div class="kpi">{{ inactive_accounts or 0 }}</div>
        <div class="text-muted small mt-1">No invoice OR last invoice &gt; 90 days.</div>
      </div>
    </div>
  </div>
</div>

<div class="card card-soft">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="fw-semibold">Client Revenue & Activity</div>
      <div class="text-muted small">
        Revenue windows are based on invoice totals (excluding Cancelled).
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>AM</th>
            <th>Client</th>
            <th class="text-end">Rev (30d)</th>
            <th class="text-end">Rev (60d)</th>
            <th class="text-end">Rev (90d)</th>
            <th>Trend</th>
            <th>Last Invoice</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            {% set row_cls = 'row-inactive' if r.status == 'Inactive' else ('row-risk' if r.status == 'Dormant Risk' else '') %}
            <tr class="{{ row_cls }}">
              <td>
                <div class="fw-semibold">{{ r.am.name }}</div>
                <div class="text-muted small">{{ r.am.email }}</div>
              </td>

              <td>
                <div class="fw-semibold">{{ r.client.company_name }}</div>
                <div class="text-muted small">Client ID: {{ r.client.id }}</div>
              </td>

              <td class="text-end">{{ "%.2f"|format(r.rev_30 or 0) }}</td>
              <td class="text-end">{{ "%.2f"|format(r.rev_60 or 0) }}</td>
              <td class="text-end">{{ "%.2f"|format(r.rev_90 or 0) }}</td>

              <td>
                {% if r.trend == 'Up' %}
                  <span class="badge-soft b-green">Up</span>
                {% elif r.trend == 'Down' %}
                  <span class="badge-soft b-red">Down</span>
                {% else %}
                  <span class="badge-soft b-amber">Stable</span>
                {% endif %}
              </td>

              <td>{{ r.last_invoice_date or "—" }}</td>

              <td>
                {% if r.status == 'Active' %}
                  <span class="badge-soft b-green">Active</span>
                {% elif r.status == 'Dormant Risk' %}
                  <span class="badge-soft b-amber">Dormant Risk</span>
                {% else %}
                  <span class="badge-soft b-red">Inactive</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}

          {% if rows|length == 0 %}
            <tr><td colspan="8" class="text-center text-muted p-5">No AM clients found for selected cluster</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <div class="text-muted small mt-2">
      Notes:
      <ul class="mb-0">
        <li><b>AM → Client mapping</b> is derived from Projects where <code>Project.account_manager_user_id</code> is set.</li>
        <li><b>Trend</b> compares last 30 days revenue vs previous 30 days (±10% band).</li>
      </ul>
    </div>
  </div>
</div>

{% endblock %}