{% extends "base.html" %}
{% block title %}Collections & Aging{% endblock %}
{% block header %}Collections & Aging{% endblock %}

{% block content %}
<style>
  .kpi { font-size: 1.25rem; font-weight: 800; }
  .muted { color:#6c757d; }
  .badge-soft { padding:.4rem .6rem; border-radius:999px; font-weight:700; }
  .b0 { background: rgba(25,135,84,.15); color:#146c43; }
  .b1 { background: rgba(13,110,253,.15); color:#084298; }
  .b2 { background: rgba(245,124,0,.15); color:#c25f00; }
  .b3 { background: rgba(220,53,69,.15); color:#b02a37; }

  /* print/pdf friendly */
  @media print{
    .no-print{ display:none !important; }
    .card, .shadow-soft { box-shadow:none !important; }
    body { background:#fff !important; }
  }
</style>

{% set cluster_label = (cluster.name if cluster else "All Clusters") %}

<div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
  <form method="get" class="d-flex gap-2 align-items-end no-print">
    <div>
      <label class="form-label mb-1">Month</label>
      <input type="month" class="form-control" name="month" value="{{ month_value }}">
    </div>

    <div>
      <label class="form-label mb-1">Cluster</label>
      <select class="form-select" name="cluster_id">
        <option value="">All Clusters</option>
        {% for c in clusters %}
          <option value="{{ c.id }}" {% if cluster_id == (c.id|string) %}selected{% endif %}>
            {{ c.name }}
          </option>
        {% endfor %}
      </select>

    </div>

    <div class="pb-1 d-flex gap-2">
      <button class="btn btn-outline-dark">
        <i class="bi bi-funnel me-1"></i>Apply
      </button>

      <a class="btn btn-dark"
         href="{{ url_for('reports.cluster_collections_aging', month=month_value, cluster_id=cluster_id, format='pdf') }}">
        <i class="bi bi-file-earmark-pdf me-1"></i>Download PDF
      </a>
    </div>
  </form>

  <div class="text-muted small text-end">
    <div>
      Cluster: <span class="fw-semibold">{{ cluster_label }}</span>
    </div>
    <div>
      Period: <span class="fw-semibold">{{ start_date }}</span> to <span class="fw-semibold">{{ end_date }}</span>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-md-6">
    <div class="card shadow-soft">
      <div class="card-body">
        <div class="muted small">Total Outstanding</div>
        <div class="kpi">{{ "%.2f"|format(total_outstanding or 0) }}</div>
        <div class="text-muted small mt-1">Unpaid/partially paid invoices (based on remaining amount).</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6">
    <div class="card shadow-soft">
      <div class="card-body">
        <div class="muted small">60+ Days Exposure</div>
        <div class="kpi">{{ "%.2f"|format(exposure_60 or 0) }}</div>
        <div class="text-muted small mt-1">Cashflow risk from invoices overdue &gt; 60 days.</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-12 col-lg-6">
    <div class="card shadow-soft">
      <div class="card-body">
        <div class="fw-semibold mb-2">Aging Buckets</div>
        <div class="d-flex flex-wrap gap-2">
          <span class="badge-soft b0">0–30: {{ buckets['0-30']|length }}</span>
          <span class="badge-soft b1">31–60: {{ buckets['31-60']|length }}</span>
          <span class="badge-soft b2">61–90: {{ buckets['61-90']|length }}</span>
          <span class="badge-soft b3">90+: {{ buckets['90+']|length }}</span>
        </div>
        <div class="text-muted small mt-2">
          Buckets are based on <b>Today − Due Date</b> (Due Date defaults to invoice date if missing).
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-soft">
      <div class="card-body">
        <div class="fw-semibold mb-2">Top 10 Overdue</div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Invoice</th>
                <th class="text-end">Days</th>
                <th class="text-end">Remaining</th>
              </tr>
            </thead>
            <tbody>
              {% for r in top_overdue %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ r.invoice.invoice_no }}</div>
                  <div class="text-muted small">{{ r.invoice.client.company_name if r.invoice.client else '' }}</div>
                </td>
                <td class="text-end">{{ r.days_outstanding }}</td>
                <td class="text-end">{{ "%.2f"|format(r.remaining or 0) }}</td>
              </tr>
              {% endfor %}
              {% if top_overdue|length == 0 %}
                <tr><td colspan="3" class="text-center text-muted py-3">No overdue invoices</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-soft">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="fw-semibold">Invoice Aging Detail</div>
      <div class="text-muted small">Includes only invoices with remaining amount &gt; 0</div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Invoice</th>
            <th>Client</th>
            <th>Due Date</th>
            <th class="text-end">Days Outstanding</th>
            <th class="text-end">Remaining</th>
            <th>Responsible</th>
            <th>Bucket</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr>
            <td>
              <a href="{{ url_for('invoices.view_invoice', invoice_id=r.invoice.id) }}"
                 class="fw-semibold text-decoration-none">
                {{ r.invoice.invoice_no }}
              </a>
              <div class="text-muted small">{{ r.invoice.invoice_date }}</div>
            </td>
            <td>{{ r.invoice.client.company_name if r.invoice.client else "—" }}</td>
            <td>{{ r.due_date }}</td>
            <td class="text-end">{{ r.days_outstanding }}</td>
            <td class="text-end">{{ "%.2f"|format(r.remaining or 0) }}</td>
            <td>{{ r.responsible }}</td>
            <td>
              {% if r.bucket == '0-30' %}
                <span class="badge-soft b0">0–30</span>
              {% elif r.bucket == '31-60' %}
                <span class="badge-soft b1">31–60</span>
              {% elif r.bucket == '61-90' %}
                <span class="badge-soft b2">61–90</span>
              {% else %}
                <span class="badge-soft b3">90+</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}

          {% if rows|length == 0 %}
            <tr><td colspan="7" class="text-center text-muted p-5">No outstanding invoices found for this month</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}