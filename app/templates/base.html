<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Crystal Nexus{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --nav-bg:#0b1f3a;
      --nav-fg:rgba(255,255,255,.86);
      --nav-fg-strong:#fff;
      --nav-hover:rgba(255,255,255,.10);
      --nav-active:#ff7a00;
      --nav-active-fg:#0b1f3a;
    }

    body { background: #f6f7fb; }
    .app-shell { min-height: 100vh; }

    .sidebar { width: 260px; background: var(--nav-bg); color: #fff; }
    .sidebar .brand { font-weight: 700; letter-spacing: .4px; }

    .nav-section-title{
      font-size: .75rem;
      letter-spacing: .04em;
      text-transform: uppercase;
      opacity: .65;
      margin: .85rem 0 .4rem;
      padding: 0 .2rem;
    }

    .sidebar a, .sidebar button.nav-toggle {
      color: var(--nav-fg);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: .55rem;
      width: 100%;
      padding: .65rem .9rem;
      border-radius: .65rem;
      border: 0;
      background: transparent;
      text-align: left;
    }

    .sidebar a:hover, .sidebar button.nav-toggle:hover {
      background: var(--nav-hover);
      color: var(--nav-fg-strong);
    }

    .sidebar a.active {
      background: var(--nav-active);
      color: var(--nav-active-fg);
      font-weight: 700;
    }

    /* ✅ Fix submenu indentation + overshoot */
    .submenu{
      padding-left: .25rem;
      padding-right: .25rem;
    }
    .submenu a{
      padding-left: 2.1rem;   /* not too deep */
      border-radius: .65rem;
      margin-left: .15rem;
      margin-right: .15rem;
    }

    .sidebar .nav-toggle .chev {
      margin-left: auto;
      transition: transform .15s ease;
      opacity: .9;
    }
    .sidebar .nav-toggle[aria-expanded="true"] .chev { transform: rotate(180deg); }

    .topbar { background: #fff; border-bottom: 1px solid #e9ecef; }
    .card { border: 0; border-radius: 1rem; }
    .shadow-soft { box-shadow: 0 12px 30px rgba(15,23,42,.06); }
    .btn, .badge, .form-control, .form-select { border-radius: .8rem; }
  </style>
</head>

<body>
{% set ep = request.endpoint or '' %}
{% set path = request.path or '' %}

<div class="d-flex app-shell">
  <!-- SIDEBAR -->
  <aside class="sidebar p-3 d-none d-lg-flex flex-column">
    <div class="d-flex align-items-center gap-2 mb-3">
      <i class="bi bi-gem fs-4 text-warning"></i>
      <div>
        <div class="brand">Crystal Nexus</div>
        <div class="small opacity-75">Lead Management</div>
      </div>
    </div>

    <nav class="d-grid gap-1">

      {# ✅ Dynamic menus from DB (already filtered by permissions in context_processor) #}
      {% if sidebar_menus and sidebar_menus|length > 0 %}

        {% for m in sidebar_menus %}
          {% set menu_id = "menuCollapse" ~ loop.index %}
          {% set is_menu_open = false %}

          {# if any submenu matches current path/endpoint, keep menu open #}
          {% for s in m.submenus %}
            {% if s.href and (path.startswith(s.href) or ep in (s.href|string)) %}
              {% set is_menu_open = true %}
            {% endif %}
          {% endfor %}

          <div class="nav-section-title">{{ m.title }}</div>

          <button class="nav-toggle"
                  data-bs-toggle="collapse"
                  data-bs-target="#{{ menu_id }}"
                  aria-expanded="{{ 'true' if is_menu_open else 'false' }}">
            <span>
              <i class="bi bi-{{ m.icon or 'list' }}"></i>
              {{ m.title }}
            </span>
            <i class="bi bi-chevron-down chev"></i>
          </button>

          <div class="collapse {% if is_menu_open %}show{% endif %}" id="{{ menu_id }}">
            <div class="submenu d-grid gap-1">
              {% for s in m.submenus %}
                {% set active = (s.href and (path == s.href or path.startswith(s.href))) %}
                <a href="{{ s.href }}" class="{{ 'active' if active else '' }}">
                  <i class="bi bi-{{ s.icon or 'dot' }}"></i>
                  {{ s.title }}
                </a>
              {% endfor %}
            </div>
          </div>
        {% endfor %}

      {% else %}
        <div class="p-2 small opacity-75">
          No menus found. (Check Menu/SubMenu seed + permissions)
        </div>
      {% endif %}

      <hr class="opacity-25">

      <a href="{{ url_for('auth.logout') }}">
        <i class="bi bi-box-arrow-right me-2"></i> Logout
      </a>
    </nav>

    <div class="mt-auto small opacity-75">
      <i class="bi bi-person-circle me-1"></i> {{ current_user.name if current_user.is_authenticated else '' }}
    </div>
  </aside>

  <!-- MAIN -->
  <main class="flex-grow-1">
    <div class="topbar px-3 py-2">
      <div class="fw-semibold">{% block header %}{% endblock %}</div>
    </div>

    <div class="container-fluid p-4">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% for cat, msg in messages %}
          <div class="alert alert-{{ cat }} shadow-soft">{{ msg }}</div>
        {% endfor %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>