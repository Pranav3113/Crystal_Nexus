{% extends "base.html" %}
{% block title %}Proforma Invoice{% endblock %}
{% block header %}Proforma Invoice{% endblock %}
{% block content %}

<div class="no-print d-flex justify-content-between align-items-center mb-3">
  <div>
    <div class="text-muted small">Proforma Invoice</div>
    <h4 class="mb-0">{{ pi.pi_no }}</h4>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('quotes.view_quote', quote_id=quote.id) }}">
      Back to Quote
    </a>

    <a class="btn btn-outline-primary"
       href="{{ url_for('proforma.download_pi', pi_id=pi.id) }}">
      <i class="bi bi-download me-1"></i>Download PDF
    </a>

    {% if pi.status == "Issued" %}
      {% if latest_inv %}
        <a class="btn btn-success" href="{{ url_for('invoices.view_invoice', invoice_id=latest_inv.id) }}">
          <i class="bi bi-eye me-1"></i>View Invoice
        </a>
      {% else %}
        {% if current_user.has_perm("invoices.manage") %}
        <form method="post" class="m-0" action="{{ url_for('invoices.create_invoice_from_pi', pi_id=pi.id) }}"
              onsubmit="return confirm('Generate Invoice from this Proforma?');">
          <button class="btn btn-primary">
            <i class="bi bi-receipt me-1"></i>Generate Invoice
          </button>
        </form>
        {% else %}
        <button class="btn btn-outline-secondary" disabled title="You donâ€™t have permission to generate invoices.">
          <i class="bi bi-lock me-1"></i>Generate Invoice
        </button>
        {% endif %}
      {% endif %}
    {% endif %}
  </div>
</div>

{# ----- Pass variables to shared doc layout ----- #}
{% set doc_title = "Proforma Invoice" %}
{% set doc_no = pi.pi_no %}
{% set doc_date = pi.pi_date %}
{% set doc = pi %}
{% set client = pi.client %}
{% set branch = pi.client_branch %}
{% set company_branch = pi.company_branch %}

{% set items = quote.items.order_by(
  quote.items.column_descriptions[0]['entity'].sort_order.asc(),
  quote.items.column_descriptions[0]['entity'].id.asc()
).all() %}

{% include "billing/_doc_layout.html" with context %}

{% endblock %}