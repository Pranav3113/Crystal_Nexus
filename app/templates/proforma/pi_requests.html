{% extends "base.html" %}
{% block title %}Pending PI Requests{% endblock %}
{% block header %}Pending PI Requests{% endblock %}

{% block content %}

<style>
  .card-soft { border: 1px solid rgba(0,0,0,.06); border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.04); }
  .badge-soft { padding: .45rem .75rem; border-radius: 999px; font-weight: 600; font-size: .75rem; }
  .badge-pending { background: rgba(245,124,0,.15); color:#c25f00; }
  .badge-sent { background: rgba(13,110,253,.12); color:#0b5ed7; }
  .mono { font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
</style>

<div class="card card-soft">
  <div class="card-body">

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <div>
        <div class="fw-semibold">
          Pending PI Requests <span class="badge-soft badge-pending">Pending</span>
        </div>
        <div class="text-muted small">
          Generate PI only after Proposal is Confirmed and Quote status is <b>Sent</b>.
        </div>
      </div>

      <div style="max-width:320px;">
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input id="q" type="text" class="form-control" placeholder="Search quote / opp / company...">
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:140px;">Quote</th>
            <th>Opportunity</th>
            <th style="width:180px;">Requested</th>
            <th style="width:200px;">Eligibility</th>
            <th class="text-end" style="width:240px;">Action</th>
          </tr>
        </thead>

        <tbody id="rows">
          {% for q in items %}
          {% set can_generate = (q.proposal_confirmed_at is not none)
                                and (q.status and q.status.name == "Sent")
                                and (q.pi_request_status == "Pending") %}
          <tr>
            <td>
              <div class="fw-semibold">
                <a class="text-decoration-none" href="{{ url_for('quotes.view_quote', quote_id=q.id) }}">
                  {{ q.quote_code }}
                </a>
              </div>
              <div class="small text-muted">v{{ q.version }}</div>
              <div class="small">
                <span class="badge-soft badge-sent">{{ q.status.name if q.status else '—' }}</span>
              </div>
            </td>

            <td>
              <div class="fw-semibold">{{ q.opportunity.title if q.opportunity else '—' }}</div>
              <div class="small text-muted">{{ q.opportunity.company if q.opportunity else '—' }}</div>
            </td>

            <td>
              <div class="badge-soft badge-pending">Pending</div>
              <div class="small text-muted mt-1">
                {% if q.pi_requested_at %}
                  <span class="mono">{{ q.pi_requested_at.strftime("%d %b %Y, %I:%M %p") }}</span>
                {% else %}
                  —
                {% endif %}
                {% if q.pi_requested_by %}
                  <div>by {{ q.pi_requested_by.name }}</div>
                {% endif %}
              </div>

              {% if q.pi_request_note %}
                <div class="small text-muted mt-1" style="white-space: pre-wrap;">{{ q.pi_request_note }}</div>
              {% endif %}
            </td>

            <td>
              <div class="small">
                {% if q.proposal_confirmed_at %}
                  <span class="text-success"><i class="bi bi-check-circle me-1"></i>Proposal Confirmed</span>
                {% else %}
                  <span class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>Not Confirmed</span>
                {% endif %}
              </div>
              <div class="small mt-1">
                {% if q.status and q.status.name == "Sent" %}
                  <span class="text-success"><i class="bi bi-check-circle me-1"></i>Status Sent</span>
                {% else %}
                  <span class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>Not Sent</span>
                {% endif %}
              </div>
            </td>

            <td class="text-end">
              <div class="d-inline-flex gap-2 flex-wrap justify-content-end">

                <a class="btn btn-outline-secondary btn-sm"
                   href="{{ url_for('quotes.view_quote', quote_id=q.id) }}">
                  <i class="bi bi-eye me-1"></i>View
                </a>

                {% if can_generate %}
                  <form method="post" class="m-0"
                        action="{{ url_for('proforma.create_pi_from_quote', quote_id=q.id) }}"
                        onsubmit="return confirm('Generate Proforma Invoice now?');">
                    <button class="btn btn-dark btn-sm">
                      <i class="bi bi-receipt me-1"></i>Generate PI
                    </button>
                  </form>
                {% else %}
                  <button class="btn btn-outline-secondary btn-sm" type="button" disabled
                          title="PI can be generated only after Proposal is Confirmed and Quote status is Sent.">
                    <i class="bi bi-lock me-1"></i>Generate PI
                  </button>
                {% endif %}

              </div>
            </td>
          </tr>
          {% endfor %}

          {% if items|length == 0 %}
          <tr>
            <td colspan="5" class="text-center text-muted py-5">
              <i class="bi bi-inbox fs-3 d-block mb-2"></i>
              No pending PI requests found.
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<script>
  const q = document.getElementById('q');
  const rows = document.querySelectorAll('#rows tr');

  q?.addEventListener('input', () => {
    const needle = (q.value || '').toLowerCase();
    rows.forEach(r => {
      const txt = (r.innerText || '').toLowerCase();
      r.style.display = txt.includes(needle) ? '' : 'none';
    });
  });
</script>

{% endblock %}